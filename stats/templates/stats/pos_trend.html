{% extends "stats/base.html" %}
{% block content %}

<section class="section">
  <h2 class="section-title">Posiciones de Pescara por Jornada</h2>

  {% if rows %}
    <div class="spark-wrap">

      <svg viewBox="0 0 {{ spark_w }} {{ spark_h }}" width="100%" height="260"
           class="sparkline" role="img" aria-label="Trayectoria de posición por jornada">

        <!-- background card -->
        <rect x="2" y="2" width="{{ spark_w|add:'-4' }}" height="{{ spark_h|add:'-4' }}" rx="12" ry="12"
              fill="#132333" stroke="none" />

        <!-- axes frame -->
        <rect x="36" y="12" width="{{ spark_w|add:'-48' }}" height="{{ spark_h|add:'-36' }}"
              rx="8" ry="8" fill="none" stroke="#00d4ff" stroke-width="2" />

        <!-- fixed Y ticks at 1,5,10,15,20,25 -->
        {% for t in y_labels %}
          <line x1="36" y1="{{ t.y }}" x2="{{ spark_w|add:'-12' }}" y2="{{ t.y }}"
                stroke="#1e2d3a" stroke-width="1" />
          <text x="28" y="{{ t.y|add:'4' }}" fill="#b6c7d6" font-size="12" font-weight="700" text-anchor="end">
            {{ t.text }}
          </text>
        {% endfor %}

        <!-- trajectory (line only through existing jornadas) -->
        {% if spark_dots and spark_dots|length > 1 %}
          <polyline fill="none" stroke="#46a0ff" stroke-width="3"
                    points="{% for d in spark_dots %}{{ d.cx }},{{ d.cy }}{% if not forloop.last %} {% endif %}{% endfor %}" />
        {% endif %}

        <!-- dots with white numbers -->
        {% for d in spark_dots %}
          <g>
            <circle cx="{{ d.cx }}" cy="{{ d.cy }}" r="14" fill="#46a0ff" opacity="0.25" />
            <circle cx="{{ d.cx }}" cy="{{ d.cy }}" r="12" fill="#46a0ff" stroke="#bfe1ff" stroke-width="2">
              <title>J{{ d.label }}</title>
            </circle>
            {% if d.pos %}
              <text x="{{ d.cx }}" y="{{ d.cy|add:'5' }}" fill="#ffffff"
                    font-size="14" font-weight="900" text-anchor="middle">{{ d.pos }}</text>
            {% endif %}
          </g>
        {% endfor %}

        <!-- X axis labels: always J1..J{total_rounds} -->
        {% for lab in x_labels %}
          <text x="{{ lab.x }}" y="{{ spark_h|add:'-8' }}" fill="#b6c7d6"
                font-size="12" font-weight="700" text-anchor="middle">{{ lab.text }}</text>
        {% endfor %}

        {% if not spark_dots or spark_dots|length < 2 %}
          <text x="48" y="36" fill="#ffdd57" font-size="12" font-weight="700">
            Faltan datos para la trayectoria (se necesitan ≥ 2 jornadas)
          </text>
        {% endif %}
      </svg>
    </div>

    <div class="spark-meta" style="margin: 6px 0 14px; color:#9fb4c6; font-size:12px;">
      Jornadas {{ jornada_span }}
    </div>

    <div class="pos-trend-wrap">
      <table class="pos-trend">
        <thead>
          <tr>
            <th>Jornada</th>
            <th>Resultado</th>
            <th>Posición</th>
            <th>Puntos</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td class="td-j">
                <div style="display:flex;align-items:center;gap:8px">
                  <span>J{{ r.jornada }}</span>
                  {% if r.opp_logo %}
                    <img src="{{ r.opp_logo }}" alt="{{ r.opp_name }}" title="{{ r.opp_name }}"
                         style="width:24px;height:24px;object-fit:contain;display:inline-block;vertical-align:middle;">
                  {% endif %}
                </div>
              </td>
              <td class="td-res">
                {% if r.score %}
                  <span class="reschip {{ r.res_class }}">{{ r.score }}</span>
                {% else %}
                  <span class="reschip none">—</span>
                {% endif %}
              </td>
              <td class="td-pos">
                <span class="poschip" style="--chip-bg: {{ r.color }};">
                  {{ r.position }}
                </span>
              </td>
              <td class="td-pts">{{ r.points }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No hay datos de tabla para Pescara.</p>
  {% endif %}
</section>

{% endblock %}